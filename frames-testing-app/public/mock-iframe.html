<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mock Iframe</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      padding: 20px;
      background-color: #f7f7f7;
      color: #333;
    }
    #message-log {
      margin-top: 20px;
      padding: 10px;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
    }
    .log-entry {
      margin-bottom: 5px;
      padding: 5px;
      border-bottom: 1px solid #eee;
    }
    .received {
      color: #2563eb;
    }
    .sent {
      color: #059669;
    }
  </style>
</head>
<body>
  <h2>Mock Iframe</h2>
  <p>This iframe handles message communication with the parent.</p>
  <button id="sign-message-btn">Simulate Sign Message Response</button>
  <div id="message-log"></div>

  <script>
    // Initialize variables
    const messageLog = document.getElementById('message-log');
    const signMessageBtn = document.getElementById('sign-message-btn');
    let lastRequestId = null;

    // Function to log messages
    function logMessage(message, type) {
      const entry = document.createElement('div');
      entry.className = `log-entry ${type}`;
      entry.textContent = `${type === 'received' ? 'ðŸ“¥' : 'ðŸ“¤'} ${JSON.stringify(message)}`;
      messageLog.appendChild(entry);
      messageLog.scrollTop = messageLog.scrollHeight;
    }

    // Function to send messages to the parent
    function sendMessageToParent(message) {
      window.parent.postMessage(message, '*');
      logMessage(message, 'sent');
    }

    // Handle sign message button click
    signMessageBtn.addEventListener('click', () => {
      // Simulate a response to a sign message request
      sendMessageToParent({
        type: 'response:sign-message',
        value: {
          signature: 'simulated-signature-' + Date.now(),
          message: 'Hello, World!'
        },
        requestId: lastRequestId || 'no-request'
      });
    });

    // Listen for messages from the parent
    window.addEventListener('message', (event) => {
      const message = event.data;
      logMessage(message, 'received');

      // Check if it's a handshake init message
      if (message && message.type === 'handshake:init') {
        console.log('Received handshake init, sending ready');
        // Send handshake ready message
        sendMessageToParent({
          type: 'handshake:ready'
        });
      }
      // Check if it's a handshake acknowledgment
      else if (message && message.type === 'handshake:ack') {
        console.log('Handshake completed');
      }
      // Handle sign message request
      else if (message && message.type === 'request:sign-message') {
        console.log('Received sign message request:', message);
        lastRequestId = message.requestId;
        
        // Automatically respond after a delay to simulate processing
        setTimeout(() => {
          sendMessageToParent({
            type: 'response:sign-message',
            value: {
              signature: 'auto-signature-' + Date.now(),
              message: message.value || 'Default message'
            },
            requestId: message.requestId
          });
        }, 1000);
      }
    });

    // Log initialization
    logMessage({ status: 'Mock iframe initialized' }, 'sent');
  </script>
</body>
</html> 