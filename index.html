<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ”‘ Crossmint Signers Vault</title>
    <link rel="stylesheet" href="css/styles.css">
    <!-- For production use: -->
    <script src="dist/bundle.min.js"></script>
    
    <!-- For development use (uncomment when debugging): -->
    <!-- <script src="dist/bundle.js"></script> -->
    
    <!-- Environment configuration -->
    <script>
        window.ENV = {
            API_URL: "http://localhost:3000/api",
            ENVIRONMENT: "development",
            APP_VERSION: "1.0.0",
            THEME: "default",
            STORAGE_PREFIX: "crossmint-signers"
        };
    </script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ðŸ”‘ Crossmint Signers Vault</h1>
        </header>
        <div class="status-container">
            <div class="status" id="status">Loaded. Waiting for parent handshake...</div>
        </div>
        
        <div class="demo-section">
            <div class="event-box">
                <div class="event-box-header">
                    <h3>Event Log</h3>
                    <button class="clear-events" id="clear-events">Clear</button>
                </div>
                <div class="event-box-body" id="event-log">
                    <div class="event-item event-info">Listening for events...</div>
                </div>
            </div>
            
            <!-- Key Shards Display Section -->
            <div class="storage-container">
                <div class="tab-container">
                    <div class="tab active" id="keys-tab">Key Shards</div>
                </div>
                <div class="storage-controls">
                    <button class="refresh-button" id="refresh-keys">Refresh</button>
                </div>
                <div class="tab-content active" id="keys-content">
                    <table class="storage-table" id="keys-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Type</th>
                                <th>Created</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="keys-table-body">
                            <tr>
                                <td colspan="4" class="loading-message">Loading key shards...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        Crossmint Signers Vault
    </div>

    <!-- Initialize demo -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize the XMIF framework
            if (window.XMIF) {
                window.XMIF.init({
                    environment: window.ENV.ENVIRONMENT,
                    apiUrl: window.ENV.API_URL,
                    storagePrefix: window.ENV.STORAGE_PREFIX
                })
                .then(() => {
                    console.log('XMIF framework initialized');
                    document.getElementById('status').textContent = 'Ready';
                    
                    // Set up event logging
                    setupEventLog();
                    
                    // Load key shards
                    loadKeyShards();
                    
                    // Set up refresh button
                    document.getElementById('refresh-keys').addEventListener('click', loadKeyShards);
                })
                .catch(err => {
                    console.error('Failed to initialize XMIF:', err);
                    document.getElementById('status').textContent = `Error: ${typeof err === 'string' ? err : err.message}`;
                    logEvent('Error', err.message ?? (typeof err === 'string' ? err : 'Unknown error'), true);
                });
            } else {
                document.getElementById('status').textContent = 'Error: XMIF not loaded';
                logEvent('Error', 'XMIF framework not loaded', true);
            }
            
            // Set up event logging system
            function setupEventLog() {
                // Clear events button
                document.getElementById('clear-events').addEventListener('click', () => {
                    document.getElementById('event-log').innerHTML = '';
                    logEvent('Info', 'Event log cleared');
                });
            }
            
            // Log an event to the event box
            function logEvent(type, message, isError = false) {
                const eventLog = document.getElementById('event-log');
                const eventItem = document.createElement('div');
                
                let className = 'event-item ';
                if (isError) {
                    className += 'event-error';
                } else if (type === 'Storage') {
                    className += 'event-incoming';
                } else {
                    className += 'event-info';
                }
                
                eventItem.className = className;
                
                const timestamp = new Date().toLocaleTimeString();
                eventItem.innerHTML = `<strong>${timestamp} - ${type}:</strong> ${message}`;
                
                // Add to the top 
                if (eventLog.firstChild) {
                    eventLog.insertBefore(eventItem, eventLog.firstChild);
                } else {
                    eventLog.appendChild(eventItem);
                }
                
                // Remove first message if it's "Waiting for events..."
                const firstItem = eventLog.querySelector('.event-item');
                if (firstItem && firstItem.textContent.includes('Waiting for events...')) {
                    eventLog.removeChild(firstItem);
                }
            }
            
            // Load key shards from IndexedDB
            function loadKeyShards() {
                const tableBody = document.getElementById('keys-table-body');
                tableBody.innerHTML = '<tr><td colspan="4" class="loading-message">Loading key shards...</td></tr>';
                
                if (!window.XMIF) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="error-message">XMIF framework not available</td></tr>';
                    logEvent('Error', 'XMIF framework not available', true);
                    return;
                }
                
                try {
                    // Use the exposed XMIF.listItems method
                    window.XMIF.listItems('keys')
                        .then(items => {
                            if (!items || items.length === 0) {
                                tableBody.innerHTML = '<tr><td colspan="4" class="empty-message">No key shards found</td></tr>';
                                logEvent('Storage', 'No key shards found in database');
                                return;
                            }
                            
                            // Clear the table
                            tableBody.innerHTML = '';
                            
                            // Add each key shard to the table
                            items.forEach(item => {
                                const row = document.createElement('tr');
                                
                                // ID column
                                const idCell = document.createElement('td');
                                idCell.textContent = item.id.substring(0, 8) + '...'; // Truncate long IDs
                                idCell.title = item.id; // Show full ID on hover
                                row.appendChild(idCell);
                                
                                // Type column
                                const typeCell = document.createElement('td');
                                typeCell.textContent = item.type || 'N/A';
                                row.appendChild(typeCell);
                                
                                // Created column
                                const createdCell = document.createElement('td');
                                createdCell.textContent = item.created 
                                    ? new Date(item.created).toLocaleString() 
                                    : 'N/A';
                                row.appendChild(createdCell);
                                
                                // Data column
                                const dataCell = document.createElement('td');
                                const jsonViewer = document.createElement('div');
                                jsonViewer.className = 'json-viewer';
                                
                                // Create a sanitized view of the data
                                const displayData = { ...item };
                                delete displayData.id; // Already displayed in ID column
                                delete displayData.type; // Already displayed in Type column
                                delete displayData.created; // Already displayed in Created column
                                
                                jsonViewer.textContent = JSON.stringify(displayData, null, 2);
                                dataCell.appendChild(jsonViewer);
                                row.appendChild(dataCell);
                                
                                tableBody.appendChild(row);
                            });
                            
                            logEvent('Storage', `Loaded ${items.length} key shard(s)`);
                        })
                        .catch(err => {
                            console.error('Error loading key shards:', err);
                            tableBody.innerHTML = `<tr><td colspan="4" class="error-message">Error loading key shards: ${err.message || 'Unknown error'}</td></tr>`;
                            logEvent('Error', `Failed to load key shards: ${err.message || 'Unknown error'}`, true);
                        });
                } catch (err) {
                    console.error('Error accessing database:', err);
                    tableBody.innerHTML = `<tr><td colspan="4" class="error-message">Error accessing database: ${err.message || 'Unknown error'}</td></tr>`;
                    logEvent('Error', `Failed to access database: ${err.message || 'Unknown error'}`, true);
                }
            }
        });
    </script>
</body>
</html> 